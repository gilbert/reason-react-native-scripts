{"version":3,"sources":["packager.js"],"names":["projectDir","race","stopAsync","resolve","reject","setTimeout","result","readPackagerInfoAsync","packagerPid","process","kill","exit","cleanUpPackager","onReady","options","isInteractive","withTimestamp","bsbChildProcess","green","packagerReady","needsClear","logBuffer","progressBar","cwd","platform","watchmanExists","sync","status","watcherDetails","stdout","toString","parseInt","split","trim","red","cyan","e","handleLogChunk","shouldIgnoreMsg","chunk","msg","indexOf","devEnabled","includes","deviceName","message","logWithLevel","level","ERROR","yellow","packagerLogsStream","projectRoot","onStartBuildBundle","total","clear","complete","incomplete","setBundleProgressBar","onProgressBuildBundle","ticks","percent","curr","tick","onFinishBuildBundle","err","startTime","endTime","duration","updateLogs","newLogChunks","updater","forEach","map","attachLoggerStream","stream","write","tag","type","installExitHooks","startAsync","then","reason","stack","run","require","createInterface","input","stdin","output","on","emit","logStackTrace","logFn","nestedLogFn","colorFn","traceInfo","JSON","parse","bold","isLibraryFrame","line","startsWith","stackFrames","compact","lastAppCodeFrameIndex","findLastIndex","lastFrameIndexToLog","Math","min","length","unloggedFrames","i","match","str","WARN","includesStack","logLines"],"mappings":"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","file":"packager.js","sourcesContent":["// @flow\n\nimport {\n  PackagerLogsStream,\n  Project,\n  ProjectSettings,\n  ProjectUtils,\n} from 'xdl';\n\nimport _ from 'lodash';\nimport spawn from 'cross-spawn';\nimport ProgressBar from 'progress';\nimport bunyan from '@expo/bunyan';\nimport chalk from 'chalk';\nimport { spawnBsbWatcherAsync } from './bsb';\n\nimport log from './log';\n\nfunction installExitHooks(projectDir, isInteractive) {\n  if (!isInteractive && process.platform === 'win32') {\n    require('readline')\n      .createInterface({\n        input: process.stdin,\n        output: process.stdout,\n      })\n      .on('SIGINT', () => {\n        process.emit('SIGINT');\n      });\n  }\n\n  process.on('SIGINT', () => {\n    log.withTimestamp('Stopping packager...');\n    cleanUpPackager(projectDir).then(() => {\n      // TODO: this shows up after process exits, fix it\n      log.withTimestamp(chalk.green('Packager stopped.'));\n      process.exit();\n    });\n  });\n}\n\nasync function cleanUpPackager(projectDir) {\n  const result = await Promise.race([\n    Project.stopAsync(projectDir),\n    new Promise((resolve, reject) => setTimeout(resolve, 1000, 'stopFailed')),\n  ]);\n\n  if (result === 'stopFailed') {\n    // find RN packager pid, attempt to kill manually\n    try {\n      const { packagerPid } = await ProjectSettings.readPackagerInfoAsync(\n        projectDir\n      );\n      process.kill(packagerPid);\n    } catch (e) {\n      process.exit(1);\n    }\n  }\n}\n\nfunction shouldIgnoreMsg(msg) {\n  return msg.indexOf('Duplicate module name: bser') >= 0 ||\n    msg.indexOf('Duplicate module name: fb-watchman') >= 0 ||\n    msg.indexOf('Warning: React.createClass is no longer supported') >= 0 ||\n    msg.indexOf('Warning: PropTypes has been moved to a separate package') >= 0;\n}\n\nasync function run(\n  onReady: () => ?any,\n  options: Object = {},\n  isInteractive?: boolean = false\n) {\n  // first, run bsb\n  log.withTimestamp('Starting BuckleScript watcher for building Reason code');\n  let { bsbChildProcess } = await spawnBsbWatcherAsync();\n  log.withTimestamp(chalk.green('BuckleScript watcher started'));\n\n  let packagerReady = false;\n  let needsClear = false;\n  let logBuffer = '';\n  let progressBar;\n  const projectDir = process.cwd();\n\n  if (process.platform !== 'win32') {\n    const watchmanExists = spawn.sync('which', ['watchman']).status === 0;\n\n    if (process.platform === 'darwin' && !watchmanExists) {\n      const watcherDetails = spawn\n        .sync('sysctl', ['kern.maxfiles'])\n        .stdout.toString();\n      if (parseInt(watcherDetails.split(':')[1].trim()) < 5242880) {\n        log.withTimestamp(\n          `${chalk.red(`Unable to start server`)}\nSee https://git.io/v5vcn for more information, either install watchman or run the following snippet:\n${chalk.cyan(`  sudo sysctl -w kern.maxfiles=5242880\n  sudo sysctl -w kern.maxfilesperproc=524288`)}\n        `\n        );\n        process.exit(1);\n      }\n    } else if (!watchmanExists) {\n      try {\n        const watcherDetails = spawn\n          .sync('sysctl', ['fs.inotify.max_user_watches'])\n          .stdout.toString();\n        if (parseInt(watcherDetails.split('=')[1].trim()) < 12288) {\n          log.withTimestamp(\n            `${chalk.red(`Unable to start server`)}\n  See https://git.io/v5vcn for more information, either install watchman or run the following snippet:\n  ${chalk.cyan(`  sudo sysctl -w fs.inotify.max_user_instances=1024\n    sudo sysctl -w fs.inotify.max_user_watches=12288`)}`\n          );\n          process.exit(1);\n        }\n      } catch (e) {\n        // note(brentvatne): I'm not sure why stdout is null for some OS's\n        // https://github.com/react-community/create-react-native-app/issues/391\n        log.withTimestamp(\n          'Warning: Unable to run `sysctl fs.inotify.max_user_watches`. If you encounter issues, please refer to https://git.io/v5vcn'\n        );\n      }\n    }\n  }\n\n  const handleLogChunk = chunk => {\n    // pig, meet lipstick\n    // 1. https://github.com/facebook/react-native/issues/14620\n    // 2. https://github.com/facebook/react-native/issues/14610\n    // 3. https://github.com/react-community/create-react-native-app/issues/229#issuecomment-308654303\n    // @ide is investigating 3), the first two are upstream issues that will\n    // likely be resolved by others\n    if (shouldIgnoreMsg(chunk.msg)) {\n      return;\n    }\n\n    // we don't need to print the entire manifest when loading the app\n    if (chunk.msg.indexOf(' with appParams: ') >= 0) {\n      if (needsClear) {\n        // this is set when we previously encountered an error\n        // TODO clearConsole();\n      }\n      let devEnabled = chunk.msg.includes('__DEV__ === true');\n      log.withTimestamp(\n        `Running app on ${chunk.deviceName} in ${devEnabled ? 'development' : 'production'} mode\\n`\n      );\n      return;\n    }\n\n    if (chunk.msg === 'Dependency graph loaded.') {\n      packagerReady = true;\n      onReady();\n      return;\n    }\n\n    if (packagerReady) {\n      const message = `${chunk.msg.trim()}\\n`;\n      logWithLevel(chunk);\n\n      if (chunk.level === bunyan.ERROR) {\n        // if you run into a syntax error then we should clear log output on reload\n        needsClear = message.indexOf('SyntaxError') >= 0;\n      }\n    } else {\n      if (chunk.level >= bunyan.ERROR) {\n        log(chalk.yellow('***ERROR STARTING PACKAGER***'));\n        log(logBuffer);\n        log(chalk.red(chunk.msg));\n        logBuffer = '';\n      } else {\n        logBuffer += chunk.msg + '\\n';\n      }\n    }\n  };\n\n  // Subscribe to packager/server logs\n  let packagerLogsStream = new PackagerLogsStream({\n    projectRoot: projectDir,\n    onStartBuildBundle: () => {\n      progressBar = new ProgressBar(\n        'Building JavaScript bundle [:bar] :percent',\n        {\n          total: 100,\n          clear: true,\n          complete: '=',\n          incomplete: ' ',\n        }\n      );\n\n      log.setBundleProgressBar(progressBar);\n    },\n    onProgressBuildBundle: percent => {\n      if (!progressBar || progressBar.complete) return;\n      let ticks = percent - progressBar.curr;\n      ticks > 0 && progressBar.tick(ticks);\n    },\n    onFinishBuildBundle: (err, startTime, endTime) => {\n      if (progressBar && !progressBar.complete) {\n        progressBar.tick(100 - progressBar.curr);\n      }\n\n      if (progressBar) {\n        log.setBundleProgressBar(null);\n        progressBar = null;\n\n        if (err) {\n          log.withTimestamp(chalk.red(`Failed building JavaScript bundle`));\n        } else {\n          let duration = endTime - startTime;\n          log.withTimestamp(\n            chalk.green(`Finished building JavaScript bundle in ${duration}ms`)\n          );\n        }\n      }\n    },\n    updateLogs: updater => {\n      let newLogChunks = updater([]);\n\n      if (progressBar) {\n        // Restarting watchman causes `onFinishBuildBundle` to not fire. Until\n        // this is handled upstream in xdl, reset progress bar with error here.\n        newLogChunks.forEach(chunk => {\n          if (chunk.msg === 'Restarted watchman.') {\n            progressBar.tick(100 - progressBar.curr);\n            log.setBundleProgressBar(null);\n            progressBar = null;\n            log.withTimestamp(chalk.red('Failed building JavaScript bundle'));\n          }\n        });\n      }\n\n      newLogChunks.map(handleLogChunk);\n    },\n  });\n\n  // Subscribe to device updates separately from packager/server updates\n  ProjectUtils.attachLoggerStream(projectDir, {\n    stream: {\n      write: chunk => {\n        if (chunk.tag === 'device') {\n          handleLogChunk(chunk);\n        }\n      },\n    },\n    type: 'raw',\n  });\n\n  installExitHooks(projectDir, isInteractive);\n  log.withTimestamp('Starting packager...');\n\n  Project.startAsync(projectDir, options).then(\n    () => {},\n    reason => {\n      log.withTimestamp(chalk.red(`Error starting packager: ${reason.stack}`));\n      process.exit(1);\n    }\n  );\n}\n\nconst logStackTrace = (chunk, logFn, nestedLogFn, colorFn) => {\n  let traceInfo;\n  try {\n    traceInfo = JSON.parse(chunk.msg);\n  } catch (e) {\n    return logFn(colorFn(chunk.msg));\n  }\n\n  let { message, stack } = traceInfo;\n  logFn(colorFn(chalk.bold(message)));\n\n  const isLibraryFrame = line => {\n    return line.startsWith('node_modules');\n  };\n\n  let stackFrames = _.compact(stack.split('\\n'));\n  let lastAppCodeFrameIndex = _.findLastIndex(stackFrames, line => {\n    return !isLibraryFrame(line);\n  });\n  let lastFrameIndexToLog = Math.min(\n    stackFrames.length - 1,\n    lastAppCodeFrameIndex + 2 // show max two more frames after last app code frame\n  );\n  let unloggedFrames = stackFrames.length - lastFrameIndexToLog;\n\n  // If we're only going to exclude one frame, just log them all\n  if (unloggedFrames === 1) {\n    lastFrameIndexToLog = stackFrames.length - 1;\n    unloggedFrames = 0;\n  }\n\n  for (let i = 0; i <= lastFrameIndexToLog; i++) {\n    let line = stackFrames[i];\n    if (!line) {\n      continue;\n    } else if (line.match(/react-native\\/.*YellowBox.js/)) {\n      continue;\n    }\n\n    if (line.startsWith('node_modules')) {\n      nestedLogFn(colorFn('- ' + line));\n    } else {\n      nestedLogFn(colorFn('* ' + line));\n    }\n  }\n\n  if (unloggedFrames > 0) {\n    nestedLogFn(\n      colorFn(\n        `- ... ${unloggedFrames} more stack frames from framework internals`\n      )\n    );\n  }\n};\n\nconst logWithLevel = chunk => {\n  if (!chunk.msg) {\n    return;\n  }\n\n  let colorFn = (str) => str;\n  if (chunk.level === bunyan.WARN) {\n    colorFn = chalk.yellow;\n  } else if (chunk.level === bunyan.ERROR) {\n    colorFn = chalk.red;\n  }\n\n  if (chunk.includesStack) {\n    logStackTrace(chunk, log.withTimestamp, log, colorFn);\n  } else {\n    logLines(chunk.msg, log.withTimestamp, colorFn);\n  }\n};\n\nconst logLines = (msg, logFn, colorFn) => {\n  for (let line of msg.split('\\n')) {\n    logFn(colorFn(line));\n  }\n};\n\nexport default { run };\n"]}